<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DOE Visualizer - 3 Factors</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: white;
      color: black;
    }
    .top-section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .input-table {
      flex: 0 0 auto;
    }
    table {
      border-collapse: collapse;
    }
    td, th {
      border: 1px solid #000;
      padding: 5px 10px;
      text-align: center;
    }
    .chart-box {
      flex: 1;
      max-width: 400px;
    }
    .equation-box {
      margin-top: 10px;
      font-weight: bold;
      padding: 10px;
      border: 1px solid #000;
      white-space: pre-wrap;
      max-width: 100%;
    }
    .main-effects {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .main-effects canvas {
      width: 30%;
      max-width: 300px;
    }
    .prediction-section {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #999;
      border-radius: 6px;
      max-width: 500px;
      background-color: #f0f0f0;
    }
    .prediction-section h3 {
      margin-top: 0;
    }
    .prediction-section label {
      margin-right: 5px;
      font-weight: bold;
    }
    .prediction-section input {
      width: 60px;
      margin-right: 15px;
      padding: 3px 5px;
    }
    .prediction-result {
      margin-top: 10px;
      font-weight: bold;
      color: #003366;
    }
  </style>
</head>
<body>

  <!-- Context Section -->
  <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9; border-radius: 6px;">
    <h3 style="margin-top: 0;">Factorial Design Context</h3>
    <p>
      This tool visualizes a <strong>full factorial design</strong> with <strong>3 factors</strong> (X1, X2, X3), each at <strong>2 levels</strong> (-1 for low, +1 for high).<br />
      The design consists of <strong>2Â³ = 8 runs</strong>, covering all possible combinations of factor levels.<br /><br />
      The response values (Y) are entered by the user and used to estimate a linear model with main effects and interactions. A Pareto chart shows the relative influence of each term.
    </p>
  </div>

  <h2>Design of Experiments (3 Factors - 2 Levels)</h2>
  <div class="top-section">
    <div class="input-table">
      <table>
        <thead>
          <tr><th>X1</th><th>X2</th><th>X3</th><th>Y</th></tr>
        </thead>
        <tbody id="input-rows"></tbody>
      </table>
      <button onclick="calculate()">Calculate</button>
    </div>
    <div class="chart-box">
      <canvas id="paretoChart"></canvas>
    </div>
  </div>

  <div class="equation-box" id="equation-result"></div>

  <!-- ðŸ”¹ Main Effects Plot Area -->
  <div class="main-effects">
    <canvas id="mainEffectX1"></canvas>
    <canvas id="mainEffectX2"></canvas>
    <canvas id="mainEffectX3"></canvas>
  </div>

  <!-- Predict X from Y Section -->
  <div class="prediction-section">
    <h3>Predict Factors (X1, X2, X3) from Y</h3>
    <label for="inputY">Y: </label>
    <input type="number" id="inputY" step="any" />
    <button onclick="predictX()">Predict X</button>
    <div class="prediction-result" id="predictionResult"></div>
  </div>

  <!-- Predict Y from X Section -->
  <div class="prediction-section">
    <h3>Predict Y from Factors (X1, X2, X3)</h3>
    <label for="inputX1">X1: </label>
    <input type="number" id="inputX1" step="any" min="-1" max="1" value="0" />
    <label for="inputX2">X2: </label>
    <input type="number" id="inputX2" step="any" min="-1" max="1" value="0" />
    <label for="inputX3">X3: </label>
    <input type="number" id="inputX3" step="any" min="-1" max="1" value="0" />
    <button onclick="predictYfromX()">Predict Y</button>
    <div class="prediction-result" id="predictedYResult"></div>
  </div>

  <script>
    const X1 = [-1, 1, -1, 1, -1, 1, -1, 1];
    const X2 = [-1, -1, 1, 1, -1, -1, 1, 1];
    const X3 = [-1, -1, -1, -1, 1, 1, 1, 1];
    const defaultY = [1, 2, 3, 4, 5, 6, 7, 8];

    let paretoChart;
    let mainEffectCharts = [];

    window.onload = () => {
      const tbody = document.getElementById('input-rows');
      for (let i = 0; i < 8; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${X1[i]}</td>
          <td>${X2[i]}</td>
          <td>${X3[i]}</td>
          <td><input type="number" value="${defaultY[i]}" id="Y${i}" style="width:60px" /></td>
        `;
        tbody.appendChild(row);
      }
      calculate();
    };

    function calculate() {
      const Y = [...Array(8)].map((_, i) => parseFloat(document.getElementById('Y' + i).value));
      const coeffs = getCoefficients(Y);

      const termLabels = ["", "\u00b7X1", "\u00b7X2", "\u00b7X3", "\u00b7X1X2", "\u00b7X1X3", "\u00b7X2X3", "\u00b7X1X2X3"];
      const equationText = coeffs.map((c, i) => `${i === 0 ? '' : ' + '}${c.toFixed(2)}${termLabels[i]}`).join('');
      document.getElementById("equation-result").textContent = `Estimated Equation:\nY = ${equationText}`;

      plotPareto(coeffs);
      plotMainEffects(Y);
    }

    function getCoefficients(Y) {
      const X = X1.map((_, i) => [
        1,
        X1[i],
        X2[i],
        X3[i],
        X1[i] * X2[i],
        X1[i] * X3[i],
        X2[i] * X3[i],
        X1[i] * X2[i] * X3[i]
      ]);
      const XT = math.transpose(X);
      const XTX = math.multiply(XT, X);
      const XTY = math.multiply(XT, Y);
      return math.lusolve(XTX, XTY).flat();
    }

    function plotPareto(coeffs) {
      if (paretoChart) paretoChart.destroy();
      paretoChart = new Chart("paretoChart", {
        type: "bar",
        data: {
          labels: ["X1", "X2", "X3", "X1X2", "X1X3", "X2X3", "X1X2X3"],
          datasets: [{
            label: "Effect",
            data: coeffs.slice(1).map(Math.abs),
            backgroundColor: "gray"
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Pareto Chart', color: "#000" }
          },
          scales: {
            x: { ticks: { color: "#000" }, grid: { color: "#aaa" } },
            y: { ticks: { color: "#000" }, grid: { color: "#aaa" } }
          }
        }
      });
    }

    function plotMainEffects(Y) {
      const factorLevels = [-1, 1];
      const factors = [X1, X2, X3];
      const labels = ['X1', 'X2', 'X3'];
      const canvases = ['mainEffectX1', 'mainEffectX2', 'mainEffectX3'];
      const colors = ['#e74c3c', '#27ae60', '#2980b9']; // red, green, blue

      mainEffectCharts.forEach(chart => chart.destroy());
      mainEffectCharts = [];

      for (let f = 0; f < 3; f++) {
        const avg = factorLevels.map(level => {
          let sum = 0, count = 0;
          for (let i = 0; i < 8; i++) {
            if (factors[f][i] === level) {
              sum += Y[i];
              count++;
            }
          }
          return sum / count;
        });

        const ctx = document.getElementById(canvases[f]).getContext("2d");
        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['-1', '+1'],
            datasets: [{
              label: labels[f],
              data: avg,
              borderColor: colors[f],
              backgroundColor: colors[f],
              fill: false,
              tension: 0.2,
              pointBackgroundColor: colors[f],
              pointBorderColor: '#000',
              pointRadius: 6,
              borderWidth: 3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: `Main Effect: ${labels[f]}`,
                color: '#000',
                font: { size: 16 }
              },
              legend: { display: false }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: `${labels[f]} Level`,
                  color: '#000',
                  font: { size: 14 }
                },
                ticks: { color: '#000' },
                grid: { color: '#ccc' }
              },
              y: {
                title: {
                  display: true,
                  text: 'Average Y',
                  color: '#000',
                  font: { size: 14 }
                },
                ticks: { color: '#000' },
                grid: { color: '#ccc' }
              }
            }
          }
        });
        mainEffectCharts.push(chart);
      }
    }

    function predictX() {
      const Yinput = parseFloat(document.getElementById("inputY").value);
      if (isNaN(Yinput)) {
        document.getElementById("predictionResult").textContent = "Please enter a valid number for Y.";
        return;
      }
      const Y = [...Array(8)].map((_, i) => parseFloat(document.getElementById('Y' + i).value));
      // Find closest Y in table to input Y
      let minDiff = Infinity, idx = -1;
      for (let i = 0; i < 8; i++) {
        const diff = Math.abs(Y[i] - Yinput);
        if (diff < minDiff) {
          minDiff = diff;
          idx = i;
        }
      }
      const predX = `X1 = ${X1[idx]}, X2 = ${X2[idx]}, X3 = ${X3[idx]}`;
      document.getElementById("predictionResult").textContent = `Closest match:\n${predX}`;
    }

    function predictYfromX() {
      const x1 = parseFloat(document.getElementById("inputX1").value);
      const x2 = parseFloat(document.getElementById("inputX2").value);
      const x3 = parseFloat(document.getElementById("inputX3").value);

      if ([x1, x2, x3].some(v => isNaN(v) || v < -1 || v > 1)) {
        document.getElementById("predictedYResult").textContent = "Please enter valid numbers between -1 and 1 for X1, X2, and X3.";
        return;
      }

      const Y = [...Array(8)].map((_, i) => parseFloat(document.getElementById('Y' + i).value));
      const coeffs = getCoefficients(Y);

      const predictedY = coeffs[0]
        + coeffs[1] * x1
        + coeffs[2] * x2
        + coeffs[3] * x3
        + coeffs[4] * x1 * x2
        + coeffs[5] * x1 * x3
        + coeffs[6] * x2 * x3
        + coeffs[7] * x1 * x2 * x3;

      document.getElementById("predictedYResult").textContent = `Predicted Y = ${predictedY.toFixed(3)}`;
    }
  </script>
</body>
</html>
